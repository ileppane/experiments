{% extends "global/Page.html" %}
{% load otree static %}

{% block content %}

<center>
    <h2>Quality control game</h2>
    <div id="wrapper" align="center">

        <div id="mydiv">
            <span id="circle" style="color:#ddddff;">&#9675;</span>
        </div>

        <canvas id="myCanvas" width="300px" height="300px"></canvas>
    </div>

    <div id="buttondiv" align="center">
        <p>Funnel location: (
            <span id="xposition">{{ prevx }}</span>,
            <span id="yposition">{{ prevy }}</span>)
        <br>
        Round: {{ round }} / {{ Constants.num_rounds }} ... Score: <span id="score">&nbsp;</span></p>

        <input type="hidden" name="x" id="hiddeninputx">
        <input type="hidden" name="y" id="hiddeninputy">
        <button class="btn btn-primary btn-large">Drop a new marble</button>

        <br><br>
        <button class="btn btn-primary btn-large" type="button" onclick="instructions()">View instructions</button>

    </div>
</center>
{% endblock %}

{% block scripts %}
<script>

    function instructions() {
        alert("On each round, a black marble is dropped through a funnel. The marble will land on a random location in the in the vicinity of the funnel. You are responsible of keeping the marbles as close to the centre of the area as possible. Your task is to control the location of the funnel, by moving the red circle. You can move it by dragging it. Try to keep all marbles as close to the centre of the area as possible. Your score is a sum of the distances of each new marble from the centre -- the smaller your score, the better.");
    }

    var round = {{ round }};
    var xlist = {{ allxcoord | safe }};
    var ylist = {{ allycoord | safe }};

    var x = xlist[xlist.length-1];
    var y = ylist[ylist.length-1];
    var xposfinal = 150+(x);
    var yposfinal = 150+(-y);
    var xpos = xposfinal;
    var ypos = 0;


    // THIS SETS THE SCORE UPDATE WITH 2 SECOND DELAY
    setTimeout(function(){
        document.getElementById("score").innerHTML = {{ cumulativescore | floatformat:"0" }};
    }, 2000);

    // THIS MAKES THE ANIMATE EFFECT OF THE CURRENT BALL DROPPING FROM THE FUNNEL
    var id = setInterval(frame, 10);
    function frame() {
        if (ypos == yposfinal) {
            clearInterval(id);
        } else {

            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0,0,300,300);

            // DRAW THE AXIS LINES
            ctx.beginPath();
            ctx.moveTo(150, 0);
            ctx.lineTo(150, 297);
            ctx.moveTo(0, 150);
            ctx.lineTo(297, 150);
            ctx.strokeStyle = "#aaaaaa";
            ctx.stroke();

            // DRAWS ALL BUT THE LATES BLACK BALLS IMMEDIATELY ON THE CANVAS
            for(var i = 0; i < round-1; i++) {
                ctx.beginPath();
                ctx.arc(150+(xlist[i]),150+(-ylist[i]),4,0,2*Math.PI);
                ctx.fill();
            }

            // DRAWS THE CURRENT BALL AS ANIMATED SO THAT IT DROPS FROM THE TOP,
            // WIGGLES IN THE FUNNEL, AND SHRINKS TO ITS PROPER SIZE AS IT MOVES
            ctx.beginPath();
            if (ypos < .5*yposfinal) {
                ctx.arc(xpos+50*Math.random(),ypos+50*Math.random(),4+.5*(yposfinal-ypos),0,2*Math.PI);
            } else {
                ctx.arc(xpos,ypos,4+.5*(yposfinal-ypos),0,2*Math.PI);
            }
            ctx.fill();
            ypos++;

        }
    }


    // THIS PART CREATES THE DRAGGABLE RED CIRCLE THAT APPEARS WITH SLIGHT DELAY
    setTimeout(function() {
        document.getElementById("circle").setAttribute("style", "font-size:30px; color: red;");

        divi = document.getElementById("mydiv");

        divi.style.top = 126 - {{ prevy }} + "px";
        divi.style.left = 125 + {{ prevx }} + "px";

        if ({{ prevx }} > 150) {
            divi.style.left = 260 + "px";
        }

        if ({{ prevx }} < -150) {
            divi.style.left = -15 + "px";
        }

        if ({{ prevy }} > 150) {
            divi.style.top = -15 + "px";
        }

        if ({{ prevy }} < -150) {
            divi.style.top = 260 + "px";
        }

        dragElement(document.getElementById("mydiv"));

        // default values if the circle is not moved
        document.getElementById("hiddeninputx").value = {{ prevx }};
        document.getElementById("hiddeninputy").value = {{ prevy }};

        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onpointerdown = dragMouseDown; // onmousedown

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;

                document.onpointerup = closeDragElement; // onmouseup
                // call a function whenever the cursor moves:
                document.onpointermove = elementDrag; // onmousemove
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";

/*
                if (elmnt.offsetTop - pos2 > 260) {
                    elmnt.style.top = 260 + "px";
                }

                if (elmnt.offsetTop - pos2 < -16) {
                    elmnt.style.top = -16 + "px";
                }

                if (elmnt.offsetLeft - pos1 > 261) {
                    elmnt.style.left = 261 + "px";
                }

                if (elmnt.offsetLeft - pos1 < -16) {
                    elmnt.style.left = -16 + "px";
                }
*/

                // write new position on span element
                document.getElementById("xposition").innerHTML = -150+25+(elmnt.offsetLeft - pos1);
                document.getElementById("yposition").innerHTML = 150-25-(elmnt.offsetTop - pos2);
                document.getElementById("hiddeninputx").value = -150+25+(elmnt.offsetLeft - pos1);
                document.getElementById("hiddeninputy").value = 150-25-(elmnt.offsetTop - pos2);
            }

            function closeDragElement() {
                /* stop moving when mouse button is released:*/
                document.onpointerup = null; // onmouseup
                document.onpointermove = null; // onmousemove

            }
        }

    }, 10);

</script>
{% endblock %}

{% block styles %}
<style type="text/css">

    body, html {
        position: fixed;
        width: 100%;
        height: 100%;
    }

    .page-header {
        margin-top: 10px;
        margin-bottom: 10px;
        padding-top: 0px;
    }


    #mydiv {
        position: absolute;
        left: 126px;
        top: 125px;
        text-align: center;
        cursor: move;
        height: 50px;
        width: 50px;
        line-height: 50px;
    }

    #buttondiv {
        width: 300px;
        align-items: center;
        position: relative;
        justify-content: center;
        margin: 0 auto;
    }

    #wrapper {
        height: 300px;
        width: 300px;
        align-items: center;
        position: relative;
        justify-content: center;
        background-color: #ddddff;
        margin: 0 auto;
        border-style: dotted;
    }
</style>
{% endblock %}